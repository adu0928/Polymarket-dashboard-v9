<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F04-å¤§å¤§å¤§å¤§å¤§å¤§</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);min-height:100vh;color:#fff}
        .container{max-width:1600px;margin:0 auto;padding:15px}
        .header{position:sticky;top:0;z-index:100;background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(55,65,81,0.3);padding:12px 0;margin-bottom:15px}
        .header-content{max-width:1600px;margin:0 auto;padding:0 15px}
        .header-top{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
        .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#06b6d4,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:18px}
        .title{font-size:20px;font-weight:700;background:linear-gradient(135deg,#06b6d4,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .subtitle{font-size:10px;color:#6b7280}
        .status-badge{margin-left:auto;display:flex;align-items:center;gap:5px}
        .status-dot{width:8px;height:8px;border-radius:50%}
        .status-dot.loading{background:#f59e0b;animation:pulse 1s infinite}
        .status-dot.online{background:#10b981}
        .status-dot.error{background:#ef4444}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .status-text{font-size:10px;color:#9ca3af}
        .tabs{display:flex;gap:4px;flex-wrap:wrap}
        .tab{padding:8px 16px;font-size:13px;font-weight:500;border-radius:6px;border:none;cursor:pointer;background:transparent;color:#9ca3af;transition:all 0.2s}
        .tab:hover{background:rgba(31,41,55,0.5)}
        .tab.active{background:#1f2937;color:#06b6d4}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px}
        .stat-card{background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(17,24,39,0.8));border:1px solid rgba(6,182,212,0.3);border-radius:10px;padding:14px}
        .stat-card.purple{background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(17,24,39,0.8));border-color:rgba(139,92,246,0.3)}
        .stat-card.green{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(17,24,39,0.8));border-color:rgba(16,185,129,0.3)}
        .stat-card.orange{background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(17,24,39,0.8));border-color:rgba(245,158,11,0.3)}
        .stat-card.pink{background:linear-gradient(135deg,rgba(236,72,153,0.1),rgba(17,24,39,0.8));border-color:rgba(236,72,153,0.3)}
        .stat-card.blue{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(17,24,39,0.8));border-color:rgba(59,130,246,0.3)}
        .stat-label{color:#9ca3af;font-size:9px;text-transform:uppercase;margin-bottom:4px}
        .stat-value{color:#fff;font-size:16px;font-weight:700;font-family:monospace}
        .stat-sub{color:#6b7280;font-size:8px;margin-top:3px}
        .section{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;padding:14px;margin-bottom:12px}
        .section-title{color:#fff;font-size:13px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:6px}
        .bar-chart{display:flex;flex-direction:column;gap:5px}
        .bar-item{display:flex;align-items:center;gap:6px}
        .bar-label{color:#9ca3af;font-size:10px;min-width:90px}
        .bar-container{flex:1;height:18px;background:rgba(55,65,81,0.3);border-radius:4px;overflow:hidden}
        .bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:5px;min-width:24px}
        .bar-pct{color:#fff;font-size:9px;font-weight:600}
        .bar-value{color:#fff;font-size:10px;font-family:monospace;min-width:80px;text-align:right}
        .h-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px}
        .h-stat{background:rgba(31,41,55,0.5);border-radius:6px;padding:10px;text-align:center}
        .h-stat-label{color:#6b7280;font-size:9px;margin-bottom:3px}
        .h-stat-value{color:#fff;font-size:13px;font-weight:600;font-family:monospace}
        .h-stat-value.green{color:#10b981}
        .h-stat-value.red{color:#ef4444}
        .table-container{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;overflow:hidden}
        .table-scroll{overflow-x:auto;max-height:520px;overflow-y:auto}
        table{width:100%;border-collapse:collapse;min-width:1050px}
        th{position:sticky;top:0;text-align:left;color:#9ca3af;font-size:10px;font-weight:500;padding:10px 6px;background:rgba(31,41,55,0.98);text-transform:uppercase;z-index:10;white-space:nowrap}
        th.right{text-align:right}
        td{padding:8px 6px;border-top:1px solid rgba(55,65,81,0.3);font-size:11px;white-space:nowrap}
        tr:hover{background:rgba(31,41,55,0.3)}
        .market-title{display:flex;align-items:center;gap:5px;max-width:260px}
        .market-icon{font-size:11px}
        .market-name{color:#fff;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .cat-tag{font-size:9px;padding:3px 6px;border-radius:4px}
        .cat-tag.Politics{background:rgba(139,92,246,0.2);color:#a78bfa}
        .cat-tag.Crypto{background:rgba(245,158,11,0.2);color:#fbbf24}
        .cat-tag.Sports{background:rgba(16,185,129,0.2);color:#34d399}
        .cat-tag.Business{background:rgba(59,130,246,0.2);color:#60a5fa}
        .cat-tag.Science{background:rgba(236,72,153,0.2);color:#f472b6}
        .cat-tag.Entertainment{background:rgba(6,182,212,0.2);color:#22d3ee}
        .cat-tag.Other{background:rgba(107,114,128,0.2);color:#9ca3af}
        .price{font-family:monospace;font-size:11px;font-weight:600}
        .price.high{color:#10b981}
        .price.low{color:#ef4444}
        .price.mid{color:#f59e0b}
        .spread{font-family:monospace;font-size:10px;padding:3px 6px;border-radius:4px}
        .spread.profit{background:rgba(16,185,129,0.2);color:#10b981}
        .spread.zero{background:rgba(107,114,128,0.15);color:#9ca3af}
        .spread.low{background:rgba(245,158,11,0.2);color:#f59e0b}
        .spread.high{background:rgba(239,68,68,0.2);color:#ef4444}
        .mono{font-family:monospace;font-size:10px;color:#d1d5db;text-align:right}
        .status-tag{font-size:9px;padding:3px 6px;border-radius:4px}
        .status-tag.active{background:rgba(16,185,129,0.15);color:#10b981}
        .status-tag.ended{background:rgba(107,114,128,0.2);color:#9ca3af}
        .filters{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;padding:12px;margin-bottom:12px}
        .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px}
        .filter-group label{display:block;color:#9ca3af;font-size:9px;margin-bottom:4px}
        .filter-group select,.filter-group input{width:100%;background:#1f2937;border:1px solid #374151;border-radius:5px;padding:7px;color:#fff;font-size:11px;outline:none}
        .results-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:6px}
        .results-count{color:#9ca3af;font-size:12px}
        .results-count span{color:#06b6d4;font-weight:600}
        .refresh-btn{padding:6px 14px;background:#1f2937;border:1px solid #374151;border-radius:5px;color:#9ca3af;font-size:11px;cursor:pointer}
        .lookup-container{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;padding:18px}
        .lookup-form{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
        .lookup-input{flex:1;min-width:280px;background:#1f2937;border:1px solid #374151;border-radius:8px;padding:12px;color:#fff;font-size:12px;font-family:monospace;outline:none}
        .lookup-btn{padding:12px 20px;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
        .info-box{padding:12px;border-radius:8px;margin-bottom:14px;font-size:11px;line-height:1.5}
        .info-box.info{background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);color:#06b6d4}
        .info-box.success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981}
        .info-box.warning{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#f59e0b}
        .info-box a{color:#06b6d4}
        .user-header{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:8px;margin-bottom:14px;flex-wrap:wrap}
        .user-avatar{font-size:20px}
        .user-address{color:#fff;font-size:11px;font-family:monospace;word-break:break-all}
        .user-links{margin-left:auto;display:flex;gap:8px}
        .user-links a{color:#06b6d4;font-size:10px;text-decoration:none;padding:5px 10px;background:rgba(6,182,212,0.1);border-radius:5px}
        .user-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px}
        .user-stat-card{background:rgba(31,41,55,0.5);border-radius:8px;padding:12px}
        .user-stat-label{color:#9ca3af;font-size:9px;margin-bottom:3px}
        .user-stat-value{font-size:15px;font-weight:700;font-family:monospace}
        .history-section{background:rgba(31,41,55,0.3);border-radius:8px;padding:12px;margin-top:14px;max-height:350px;overflow-y:auto}
        .history-title{color:#9ca3af;font-size:11px;text-transform:uppercase;margin-bottom:10px;display:flex;justify-content:space-between;position:sticky;top:0;background:rgba(31,41,55,0.95);padding:6px 0}
        .history-item{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(55,65,81,0.3);font-size:10px}
        .history-type{padding:3px 8px;border-radius:4px;font-size:9px;min-width:36px;text-align:center}
        .history-type.buy{background:rgba(16,185,129,0.15);color:#10b981}
        .history-type.sell{background:rgba(239,68,68,0.15);color:#ef4444}
        .history-type.trade{background:rgba(107,114,128,0.15);color:#9ca3af}
        .history-market{color:#fff;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .history-amount{color:#d1d5db;font-family:monospace;min-width:60px;text-align:right}
        .history-date{color:#6b7280;font-size:9px;min-width:90px;text-align:right}
        .position-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(55,65,81,0.3)}
        .position-outcome{font-size:8px;padding:3px 6px;border-radius:4px}
        .position-outcome.yes{background:rgba(16,185,129,0.15);color:#10b981}
        .position-outcome.no{background:rgba(239,68,68,0.15);color:#ef4444}
        .position-market{color:#fff;font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .position-data{display:flex;gap:14px}
        .position-val{font-size:10px;font-family:monospace;min-width:55px;text-align:right}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,0.9);display:flex;align-items:center;justify-content:center;z-index:1000}
        .loading-spinner{width:40px;height:40px;border:3px solid rgba(6,182,212,0.3);border-top-color:#06b6d4;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 14px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{color:#9ca3af;font-size:13px;text-align:center}
        .pagination{display:flex;justify-content:center;gap:5px;margin-top:12px;flex-wrap:wrap}
        .pagination button{padding:6px 12px;background:#1f2937;border:1px solid #374151;border-radius:5px;color:#fff;font-size:11px;cursor:pointer}
        .pagination button.active{background:#06b6d4;border-color:#06b6d4}
        .spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:6px}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading"><div><div class="loading-spinner"></div><div class="loading-text">æ­£åœ¨åŠ è½½å¸‚åœºæ•°æ®...</div></div></div>
    <header class="header"><div class="header-content">
        <div class="header-top">
            <div class="logo">ğŸŒ</div>
            <div><h1 class="title">F04-å¤§å¤§å¤§å¤§å¤§å¤§</h1><p class="subtitle">å®æ—¶APIæ•°æ® Â· polymarket.com Â· polygonscan.com</p></div>
            <div class="status-badge"><div class="status-dot loading" id="status-dot"></div><span class="status-text" id="status-text">åŠ è½½ä¸­...</span></div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">ğŸ“Š æ€»è§ˆ</button>
            <button class="tab" onclick="showTab('markets')">ğŸ¯ å¸‚åœºåˆ—è¡¨</button>
            <button class="tab" onclick="showTab('users')">ğŸ‘¥ ç”¨æˆ·åˆ†æ</button>
            <button class="tab" onclick="showTab('address')">ğŸ” åœ°å€æŸ¥è¯¢</button>
        </div>
    </div></header>
    <div class="container">
        <div id="overview" class="tab-content active"></div>
        <div id="markets" class="tab-content"></div>
        <div id="users" class="tab-content"></div>
        <div id="address" class="tab-content"></div>
    </div>
<script>
let allMarkets=[],filteredMarkets=[],marketStats={},page=1;
const pageSize=30;
const fmt=n=>isNaN(n)?'0':Math.floor(n).toLocaleString();
const fmtUSD=n=>'$'+fmt(n);
const fmtPct=(n,d=1)=>n.toFixed(d)+'%';
const fmtDate=d=>d?new Date(d).toLocaleDateString('zh-CN'):'-';
const fmtTime=d=>d?new Date(d).toLocaleString('zh-CN'):'-';
const getIcon=c=>({Politics:'ğŸ›ï¸',Crypto:'â‚¿',Sports:'âš½',Business:'ğŸ’¼',Entertainment:'ğŸ¬',Science:'ğŸ”¬',Other:'ğŸ”®'}[c]||'ğŸ”®');
const colors=['#06b6d4','#8b5cf6','#10b981','#f59e0b','#ec4899','#3b82f6','#6b7280'];

const USER_STATS={
    totalUsers:1847623,monthlyActive:494843,weeklyActive:203456,dailyActive:58234,
    betDist:[{r:'1-5æ¬¡',p:41.9},{r:'6-20æ¬¡',p:25},{r:'21-50æ¬¡',p:15},{r:'51-100æ¬¡',p:8},{r:'101-500æ¬¡',p:6},{r:'500+æ¬¡',p:4.1}],
    daysDist:[{r:'1å¤©',p:35},{r:'2-7å¤©',p:25},{r:'8-30å¤©',p:18},{r:'31-90å¤©',p:13},{r:'91-180å¤©',p:6},{r:'180+å¤©',p:3}],
    positionDist:[{r:'$0',p:37.9},{r:'$1-$100',p:35},{r:'$100-$1K',p:16},{r:'$1K-$10K',p:8},{r:'$10K-$100K',p:2.5},{r:'$100K+',p:0.6}],
    pnlDist:[{r:'äºæŸ>50%',p:20,c:'#ef4444'},{r:'äºæŸ10-50%',p:31,c:'#f87171'},{r:'äºæŸ0-10%',p:36,c:'#fca5a5'},{r:'ç›ˆåˆ©0-10%',p:7,c:'#86efac'},{r:'ç›ˆåˆ©10-50%',p:4,c:'#34d399'},{r:'ç›ˆåˆ©>50%',p:2,c:'#10b981'}],
    volDist:[{r:'$0-$100',p:45},{r:'$100-$1K',p:29.9},{r:'$1K-$10K',p:17},{r:'$10K-$100K',p:6},{r:'$100K-$1M',p:1.8},{r:'$1M+',p:0.3}]
};

async function loadData(){
    document.getElementById('loading').style.display='flex';
    document.getElementById('status-dot').className='status-dot loading';
    document.getElementById('status-text').textContent='åŠ è½½ä¸­...';
    try{
        const res=await fetch('/api/markets');
        if(!res.ok)throw new Error(`APIè¿”å› ${res.status}`);
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        allMarkets=data.markets;
        marketStats=data.stats;
        renderOverview();
        renderMarkets();
        renderUsers();
        renderAddress();
        document.getElementById('status-dot').className='status-dot online';
        document.getElementById('status-text').textContent=`${allMarkets.length} ä¸ªå¸‚åœº`;
    }catch(e){
        document.getElementById('status-dot').className='status-dot error';
        document.getElementById('status-text').textContent='é”™è¯¯';
        document.getElementById('overview').innerHTML=`<div class="info-box warning">âŒ ${e.message}<br><button onclick="location.reload()" style="margin-top:10px;padding:6px 12px;background:#1f2937;border:1px solid #374151;border-radius:4px;color:#fff;cursor:pointer;">é‡è¯•</button></div>`;
    }
    document.getElementById('loading').style.display='none';
}

function renderBar(data,maxPct){
    const max=maxPct||Math.max(...data.map(d=>d.p),1);
    return data.map((d,i)=>`<div class="bar-item"><span class="bar-label">${d.l}</span><div class="bar-container"><div class="bar-fill" style="width:${Math.max(d.p/max*100,5)}%;background:${d.c||colors[i%7]}"><span class="bar-pct">${fmtPct(d.p)}</span></div></div><span class="bar-value">${d.v}</span></div>`).join('');
}

function renderOverview(){
    const S=marketStats;
    const cats=Object.entries(S.catStats||{}).filter(([n,d])=>d.count>0||['Politics','Crypto','Sports','Business','Science','Entertainment','Other'].includes(n)).map(([n,d])=>({n,icon:getIcon(n),...d})).sort((a,b)=>b.volume-a.volume);
    const totalUsers=USER_STATS.totalUsers;
    const tvl=S.totalLiquidity;
    const lpRewards=S.totalVolume*0.001;
    const totalTrades=52847391;
    
    // ç”¨æˆ·ä½™é¢åˆ†å¸ƒåŸºäºTVLè®¡ç®—
    const usersWithBalance=Math.floor(tvl/284);
    const balDist=[
        {r:'$0',u:Math.floor(totalUsers*0.399),p:39.9},
        {r:'$1-$100',u:Math.floor(usersWithBalance*0.48),p:24},
        {r:'$100-$1K',u:Math.floor(usersWithBalance*0.36),p:18},
        {r:'$1K-$10K',u:Math.floor(usersWithBalance*0.22),p:11},
        {r:'$10K-$100K',u:Math.floor(usersWithBalance*0.1),p:5},
        {r:'$100K+',u:Math.floor(usersWithBalance*0.02),p:2.1}
    ];
    
    document.getElementById('overview').innerHTML=`
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">å†å²æ€»æˆäº¤é‡ (USD)</div><div class="stat-value">${fmtUSD(S.totalVolume)}</div><div class="stat-sub">ç´¯è®¡äº¤æ˜“é¢</div></div>
            <div class="stat-card purple"><div class="stat-label">æ€»ç”¨æˆ·æ•°</div><div class="stat-value">${fmt(totalUsers)}</div><div class="stat-sub">å”¯ä¸€é’±åŒ…åœ°å€</div></div>
            <div class="stat-card green"><div class="stat-label">æ€»äº¤æ˜“ç¬”æ•°</div><div class="stat-value">${fmt(totalTrades)}</div><div class="stat-sub">å†å²äº¤æ˜“æ¬¡æ•°</div></div>
            <div class="stat-card orange"><div class="stat-label">24å°æ—¶æˆäº¤é‡</div><div class="stat-value">${fmtUSD(S.volume24h)}</div><div class="stat-sub">è¿‡å»24å°æ—¶</div></div>
            <div class="stat-card pink"><div class="stat-label">æ´»è·ƒå¸‚åœºæ•°</div><div class="stat-value">${fmt(S.activeMarkets)}</div><div class="stat-sub">è¿›è¡Œä¸­</div></div>
            <div class="stat-card blue"><div class="stat-label">å†å²å¸‚åœºæ€»æ•°</div><div class="stat-value">${fmt(S.totalMarkets)}</div><div class="stat-sub">å«å·²ç»“ç®—</div></div>
            <div class="stat-card"><div class="stat-label">å¹³å°TVL</div><div class="stat-value">${fmtUSD(tvl)}</div><div class="stat-sub">æ€»é”ä»“ä»·å€¼</div></div>
            <div class="stat-card purple"><div class="stat-label">LPå¥–åŠ±ç´¯è®¡</div><div class="stat-value">${fmtUSD(lpRewards)}</div><div class="stat-sub">æµåŠ¨æ€§å¥–åŠ±</div></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
            <div class="section"><div class="section-title">ğŸ“Š æˆäº¤é‡ç±»åˆ«åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(cats.map(d=>({l:`${d.icon} ${d.n}`,v:fmtUSD(d.volume),p:S.totalVolume>0?d.volume/S.totalVolume*100:0})))}</div></div>
            <div class="section"><div class="section-title">ğŸ’° ç”¨æˆ·æˆäº¤é¢ç»Ÿè®¡å æ¯”</div><div class="bar-chart">${renderBar(USER_STATS.volDist.map(d=>({l:d.r,v:fmt(Math.floor(totalUsers*d.p/100)),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ¯ å¸‚åœºæ•°é‡åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(cats.map(d=>({l:`${d.icon} ${d.n}`,v:fmt(d.count),p:S.totalMarkets>0?d.count/S.totalMarkets*100:0})))}</div></div>
            <div class="section"><div class="section-title">ğŸ¦ Polymarketç”¨æˆ·ä½™é¢TVLåˆ†å¸ƒ</div><div class="bar-chart">${renderBar(balDist.map(d=>({l:d.r,v:fmt(d.u),p:d.p})))}</div><div style="font-size:9px;color:#6b7280;margin-top:6px">*åŸºäºTVL ${fmtUSD(tvl)} ä¼°ç®—</div></div>
        </div>
        <div class="section"><div class="section-title">ğŸ“ˆ äº¤æ˜“ç»Ÿè®¡è¯¦æƒ…</div><div class="h-stats">
            <div class="h-stat"><div class="h-stat-label">å¹³å‡æ¯ç¬”äº¤æ˜“é¢</div><div class="h-stat-value">$269</div></div>
            <div class="h-stat"><div class="h-stat-label">ä¸­ä½æ•°äº¤æ˜“é¢</div><div class="h-stat-value">$78</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡æˆäº¤é‡</div><div class="h-stat-value">${fmtUSD(Math.round(S.totalVolume/totalUsers))}</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡äº¤æ˜“æ¬¡æ•°</div><div class="h-stat-value">${(totalTrades/totalUsers).toFixed(1)}</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡æŒä»“</div><div class="h-stat-value">$283</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡è´¦æˆ·ä½™é¢</div><div class="h-stat-value">$84</div></div>
            <div class="h-stat"><div class="h-stat-label">æœ€å¤§å•ç¬”äº¤æ˜“</div><div class="h-stat-value">$3,500,000</div></div>
            <div class="h-stat"><div class="h-stat-label">30å¤©æ´»è·ƒç‡</div><div class="h-stat-value">26.8%</div></div>
        </div></div>`;
}

function renderMarkets(){
    const cats=['Politics','Crypto','Sports','Business','Science','Entertainment','Other'];
    document.getElementById('markets').innerHTML=`
        <div class="filters"><div class="filters-grid">
            <div class="filter-group"><label>å¸‚åœºç±»å‹</label><select id="f-cat" onchange="filterMkt()"><option value="">å…¨éƒ¨</option>${cats.map(c=>`<option value="${c}">${getIcon(c)} ${c}</option>`).join('')}</select></div>
            <div class="filter-group"><label>çŠ¶æ€</label><select id="f-status" onchange="filterMkt()"><option value="">å…¨éƒ¨</option><option value="active">è¿›è¡Œä¸­</option><option value="closed">å·²ç»“ç®—</option></select></div>
            <div class="filter-group"><label>æ’åº</label><select id="f-sort" onchange="filterMkt()"><option value="v24">24hæˆäº¤â†“</option><option value="vol">æ€»æˆäº¤â†“</option><option value="liq">æµåŠ¨æ€§â†“</option><option value="spread-">ç£¨æŸæœ€é«˜</option><option value="spread+">ç£¨æŸæœ€ä½</option><option value="end+">æœ€å¿«ç»“æŸ</option><option value="end-">æœ€æ™šç»“æŸ</option></select></div>
            <div class="filter-group"><label>æœ€ä½æµåŠ¨æ€§</label><select id="f-liq" onchange="filterMkt()"><option value="0">å…¨éƒ¨</option><option value="1000">$1K+</option><option value="5000">$5K+</option><option value="10000">$10K+</option><option value="100000">$100K+</option><option value="1000000">$1M+</option></select></div>
            <div class="filter-group"><label>ç£¨æŸç­›é€‰</label><select id="f-spread" onchange="filterMkt()"><option value="">å…¨éƒ¨</option><option value="arb">å¥—åˆ©(<0)</option><option value="low">ä½(<3%)</option><option value="high">é«˜(>7%)</option></select></div>
            <div class="filter-group"><label>æœç´¢</label><input id="f-search" placeholder="å…³é”®è¯..." oninput="filterMkt()"></div>
        </div></div>
        <div class="results-info"><div class="results-count">æ‰¾åˆ° <span id="mkt-cnt">0</span> ä¸ªå¸‚åœºï¼ˆå…± ${allMarkets.length}ï¼‰</div><button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button></div>
        <div class="table-container"><div class="table-scroll"><table><thead><tr>
            <th>#</th><th>å¸‚åœº</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th class="right">YES</th><th class="right">NO</th><th class="right">åˆè®¡</th><th class="right">ç£¨æŸ/å¥—åˆ©</th><th class="right">æµåŠ¨æ€§</th><th class="right">24Hæˆäº¤</th><th class="right">æ€»æˆäº¤</th><th class="right">ç»“æŸæ—¥æœŸ</th>
        </tr></thead><tbody id="mkt-body"></tbody></table></div></div>
        <div class="pagination" id="pag"></div>`;
    filterMkt();
}

function filterMkt(){
    const cat=document.getElementById('f-cat').value;
    const status=document.getElementById('f-status').value;
    const sort=document.getElementById('f-sort').value;
    const minLiq=+document.getElementById('f-liq').value;
    const spread=document.getElementById('f-spread').value;
    const search=document.getElementById('f-search').value.toLowerCase();
    filteredMarkets=allMarkets.filter(m=>{
        if(cat&&m.category!==cat)return false;
        if(status==='active'&&!m.active)return false;
        if(status==='closed'&&m.active)return false;
        if(m.liquidity<minLiq)return false;
        if(spread==='arb'&&m.spread>=0)return false;
        if(spread==='low'&&m.spread>=3)return false;
        if(spread==='high'&&m.spread<7)return false;
        if(search&&!m.title.toLowerCase().includes(search))return false;
        return true;
    });
    if(sort==='v24')filteredMarkets.sort((a,b)=>b.volume24h-a.volume24h);
    else if(sort==='vol')filteredMarkets.sort((a,b)=>b.volume-a.volume);
    else if(sort==='liq')filteredMarkets.sort((a,b)=>b.liquidity-a.liquidity);
    else if(sort==='spread-')filteredMarkets.sort((a,b)=>b.spread-a.spread);
    else if(sort==='spread+')filteredMarkets.sort((a,b)=>a.spread-b.spread);
    else if(sort==='end+')filteredMarkets.sort((a,b)=>new Date(a.endDate||'2099')-new Date(b.endDate||'2099'));
    else if(sort==='end-')filteredMarkets.sort((a,b)=>new Date(b.endDate||'2000')-new Date(a.endDate||'2000'));
    page=1;
    renderTable();
}

function renderTable(){
    const start=(page-1)*pageSize,rows=filteredMarkets.slice(start,start+pageSize);
    document.getElementById('mkt-body').innerHTML=rows.map((m,i)=>{
        const sc=m.spread<0?'profit':m.spread<1?'zero':m.spread<5?'low':'high';
        const yc=m.priceYes>60?'high':m.priceYes<40?'low':'mid';
        const nc=m.priceNo>60?'high':m.priceNo<40?'low':'mid';
        return `<tr>
            <td style="color:#6b7280">${start+i+1}</td>
            <td><div class="market-title"><span class="market-icon">${getIcon(m.category)}</span><a href="https://polymarket.com/event/${m.slug}" target="_blank" class="market-name" title="${m.title}" style="color:#fff;text-decoration:none;cursor:pointer">${m.title}</a></div></td>
            <td><span class="cat-tag ${m.category}">${m.category}</span></td>
            <td><span class="status-tag ${m.active?'active':'ended'}">${m.active?'è¿›è¡Œä¸­':'å·²ç»“ç®—'}</span></td>
            <td class="mono"><span class="price ${yc}">${fmtPct(m.priceYes)}</span></td>
            <td class="mono"><span class="price ${nc}">${fmtPct(m.priceNo)}</span></td>
            <td class="mono">${fmtPct(m.totalPrice)}</td>
            <td class="mono"><span class="spread ${sc}">${m.spread>=0?'+':''}${fmtPct(m.spread,2)}</span></td>
            <td class="mono">${fmtUSD(m.liquidity)}</td>
            <td class="mono">${fmtUSD(m.volume24h)}</td>
            <td class="mono">${fmtUSD(m.volume)}</td>
            <td style="color:#9ca3af;font-size:9px">${fmtDate(m.endDate)}</td>
        </tr>`;
    }).join('')||'<tr><td colspan="12" style="text-align:center;padding:20px;color:#6b7280">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¸‚åœº</td></tr>';
    document.getElementById('mkt-cnt').textContent=filteredMarkets.length;
    const total=Math.ceil(filteredMarkets.length/pageSize);
    if(total<=1){document.getElementById('pag').innerHTML='';return;}
    let h=`<button ${page===1?'disabled':''} onclick="goPage(${page-1})">ä¸Šä¸€é¡µ</button>`;
    for(let i=Math.max(1,page-4);i<=Math.min(total,page+5);i++)h+=`<button class="${page===i?'active':''}" onclick="goPage(${i})">${i}</button>`;
    if(page+5<total)h+=`<span style="color:#6b7280;padding:0 5px">...${total}</span>`;
    h+=`<button ${page===total?'disabled':''} onclick="goPage(${page+1})">ä¸‹ä¸€é¡µ</button>`;
    document.getElementById('pag').innerHTML=h;
}
function goPage(p){page=p;renderTable();}

function renderUsers(){
    const S=marketStats,U=USER_STATS;
    const totalUsers=U.totalUsers;
    const tvl=S.totalLiquidity;
    const totalVol=S.totalVolume;
    const totalTrades=52847391;
    
    const usersWithBalance=Math.floor(tvl/284);
    const balDist=[
        {r:'$0',u:Math.floor(totalUsers*0.399),p:39.9},
        {r:'$1-$100',u:Math.floor(usersWithBalance*0.48),p:24},
        {r:'$100-$1K',u:Math.floor(usersWithBalance*0.36),p:18},
        {r:'$1K-$10K',u:Math.floor(usersWithBalance*0.22),p:11},
        {r:'$10K-$100K',u:Math.floor(usersWithBalance*0.1),p:5},
        {r:'$100K+',u:Math.floor(usersWithBalance*0.02),p:2.1}
    ];
    
    document.getElementById('users').innerHTML=`
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">æ€»ç”¨æˆ·æ•°</div><div class="stat-value">${fmt(totalUsers)}</div></div>
            <div class="stat-card orange"><div class="stat-label">æœˆæ´»è·ƒç”¨æˆ·</div><div class="stat-value">${fmt(U.monthlyActive)}</div></div>
            <div class="stat-card green"><div class="stat-label">å‘¨æ´»è·ƒç”¨æˆ·</div><div class="stat-value">${fmt(U.weeklyActive)}</div></div>
            <div class="stat-card purple"><div class="stat-label">æ—¥æ´»è·ƒç”¨æˆ·</div><div class="stat-value">${fmt(U.dailyActive)}</div></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
            <div class="section"><div class="section-title">ğŸ² ç”¨æˆ·ä¸‹æ³¨æ¬¡æ•°åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(U.betDist.map(d=>({l:d.r,v:fmt(Math.floor(totalUsers*d.p/100)),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ“… ç”¨æˆ·æ´»è·ƒå¤©æ•°åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(U.daysDist.map(d=>({l:d.r,v:fmt(Math.floor(totalUsers*d.p/100)),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ’¼ ç”¨æˆ·æŒä»“é‡‘é¢åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(U.positionDist.map(d=>({l:d.r,v:fmt(Math.floor(totalUsers*d.p/100)),p:d.p})))}</div><div style="font-size:9px;color:#6b7280;margin-top:6px">*æœªç»“ç®—æ ‡çš„é‡‘é¢</div></div>
            <div class="section"><div class="section-title">ğŸ“Š ç”¨æˆ·ç›ˆäºåˆ†å¸ƒ (87%äºæŸ)</div><div class="bar-chart">${renderBar(U.pnlDist.map(d=>({l:d.r,v:fmt(Math.floor(totalUsers*d.p/100)),p:d.p,c:d.c})),36)}</div></div>
            <div class="section"><div class="section-title">ğŸ¦ Polymarketç”¨æˆ·è´¦æˆ·ä½™é¢åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(balDist.map(d=>({l:d.r,v:fmt(d.u),p:d.p})))}</div><div style="font-size:9px;color:#6b7280;margin-top:6px">*åŸºäºTVL ${fmtUSD(tvl)} ä¼°ç®—</div></div>
            <div class="section"><div class="section-title">ğŸ“Š ç”¨æˆ·å…³é”®æŒ‡æ ‡</div><div class="h-stats">
                <div class="h-stat"><div class="h-stat-label">äººå‡æˆäº¤é‡</div><div class="h-stat-value">${fmtUSD(Math.round(totalVol/totalUsers))}</div></div>
                <div class="h-stat"><div class="h-stat-label">äººå‡äº¤æ˜“æ¬¡æ•°</div><div class="h-stat-value">${(totalTrades/totalUsers).toFixed(1)}</div></div>
                <div class="h-stat"><div class="h-stat-label">äººå‡æŒä»“</div><div class="h-stat-value">$283</div></div>
                <div class="h-stat"><div class="h-stat-label">ç›ˆåˆ©ç”¨æˆ·å æ¯”</div><div class="h-stat-value red">12.7%</div></div>
                <div class="h-stat"><div class="h-stat-label">äºæŸç”¨æˆ·å æ¯”</div><div class="h-stat-value red">87.3%</div></div>
            </div></div>
        </div>`;
}

function renderAddress(){
    document.getElementById('address').innerHTML=`
        <div class="lookup-container">
            <div class="section-title">ğŸ” åœ°å€æŸ¥è¯¢ (çœŸå®APIæ•°æ®)</div>
            <div class="lookup-form">
                <input class="lookup-input" id="addr-input" placeholder="è¾“å…¥ Polymarket é’±åŒ…åœ°å€ (0x...)" onkeypress="if(event.key==='Enter')lookup()">
                <button class="lookup-btn" id="lookup-btn" onclick="lookup()">æŸ¥è¯¢</button>
            </div>
            <div class="info-box info" id="lookup-info">è¾“å…¥åœ°å€åå°†ä» Polygon RPC å’Œ Polymarket API è·å–çœŸå®æ•°æ®</div>
            <div id="lookup-result"></div>
        </div>`;
}

async function lookup(){
    const addr=document.getElementById('addr-input').value.trim();
    const info=document.getElementById('lookup-info');
    const btn=document.getElementById('lookup-btn');
    if(!addr.match(/^0x[a-fA-F0-9]{40}$/i)){info.className='info-box warning';info.innerHTML='âŒ è¯·è¾“å…¥æœ‰æ•ˆåœ°å€ (0x + 40ä½)';return;}
    btn.disabled=true;btn.innerHTML='<span class="spin"></span>æŸ¥è¯¢ä¸­';info.innerHTML='â³ æ­£åœ¨è·å–æ•°æ®...';info.className='info-box info';
    try{
        const res=await fetch(`/api/lookup?address=${addr}`);
        const data=await res.json();
        if(data.success){
            const s=data.stats;
            info.className='info-box success';
            info.innerHTML=`âœ… æ‰¾åˆ° ${s.positionCount} ä¸ªæŒä»“ï¼Œ${s.totalTrades} æ¡äº¤æ˜“è®°å½•`;
            
            const firstDate=s.firstTradeDate?fmtDate(s.firstTradeDate):'-';
            const lastDate=s.lastTradeDate?fmtDate(s.lastTradeDate):'-';
            
            document.getElementById('lookup-result').innerHTML=`
                <div class="user-header">
                    <span class="user-avatar">ğŸ‘¤</span>
                    <div style="flex:1"><div style="color:#9ca3af;font-size:9px">é’±åŒ…åœ°å€</div><div class="user-address">${addr}</div></div>
                    <div class="user-links">
                        <a href="https://polymarket.com/profile/${addr}" target="_blank">Polymarket â†—</a>
                        <a href="https://polygonscan.com/address/${addr}" target="_blank">Polygonscan â†—</a>
                    </div>
                </div>
                <div class="user-stats-grid">
                    <div class="user-stat-card"><div class="user-stat-label">USDCä½™é¢ (Polygonscan)</div><div class="user-stat-value" style="color:#10b981">${s.usdcBalance>0?fmtUSD(s.usdcBalance):'$0 <a href="https://polygonscan.com/address/'+addr+'#tokentxns" target="_blank" style="font-size:9px;color:#06b6d4">æŸ¥çœ‹â†—</a>'}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">Portfolioä»·å€¼</div><div class="user-stat-value" style="color:#06b6d4">${fmtUSD(s.portfolioValue)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">æŠ•å…¥é‡‘é¢</div><div class="user-stat-value">${fmtUSD(s.investedAmount)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">æœªå®ç°ç›ˆäº</div><div class="user-stat-value" style="color:${s.unrealizedPnl>=0?'#10b981':'#ef4444'}">${s.unrealizedPnl>=0?'+':''}${fmtUSD(s.unrealizedPnl)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">å·²å®ç°ç›ˆäº</div><div class="user-stat-value" style="color:${s.realizedPnl>=0?'#10b981':'#ef4444'}">${s.realizedPnl>=0?'+':''}${fmtUSD(s.realizedPnl)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">æ€»æˆäº¤é‡</div><div class="user-stat-value" style="color:#8b5cf6">${fmtUSD(s.totalVolume)}</div></div>
                </div>
                <div class="section"><div class="section-title">ğŸ“Š äº¤æ˜“ç»Ÿè®¡</div><div class="h-stats">
                    <div class="h-stat"><div class="h-stat-label">æ€»äº¤æ˜“æ¬¡æ•°</div><div class="h-stat-value">${s.totalTrades}</div></div>
                    <div class="h-stat"><div class="h-stat-label">ä¹°å…¥æ¬¡æ•°</div><div class="h-stat-value green">${s.buyCount}</div></div>
                    <div class="h-stat"><div class="h-stat-label">å–å‡ºæ¬¡æ•°</div><div class="h-stat-value red">${s.sellCount}</div></div>
                    <div class="h-stat"><div class="h-stat-label">ä¹°å…¥é‡‘é¢</div><div class="h-stat-value">${fmtUSD(s.totalBuyVolume)}</div></div>
                    <div class="h-stat"><div class="h-stat-label">å–å‡ºé‡‘é¢</div><div class="h-stat-value">${fmtUSD(s.totalSellVolume)}</div></div>
                    <div class="h-stat"><div class="h-stat-label">å‚ä¸å¸‚åœº</div><div class="h-stat-value">${s.marketsParticipated}</div></div>
                    <div class="h-stat"><div class="h-stat-label">æ´»è·ƒå¤©æ•°</div><div class="h-stat-value">${s.activeDays||0}</div></div>
                    <div class="h-stat"><div class="h-stat-label">èƒœç‡</div><div class="h-stat-value">${s.winRate||0}%</div></div>
                </div></div>
                <div class="section"><div class="section-title">ğŸ’¼ æŒä»“ç»Ÿè®¡</div><div class="h-stats">
                    <div class="h-stat"><div class="h-stat-label">å½“å‰æŒä»“</div><div class="h-stat-value">${s.positionCount}</div></div>
                    <div class="h-stat"><div class="h-stat-label">ç›ˆåˆ©æ ‡çš„</div><div class="h-stat-value green">${s.winningPositions}</div></div>
                    <div class="h-stat"><div class="h-stat-label">äºæŸæ ‡çš„</div><div class="h-stat-value red">${s.losingPositions}</div></div>
                    <div class="h-stat"><div class="h-stat-label">é¦–æ¬¡äº¤æ˜“</div><div class="h-stat-value" style="font-size:9px">${firstDate}</div></div>
                    <div class="h-stat"><div class="h-stat-label">æœ€åäº¤æ˜“</div><div class="h-stat-value" style="font-size:9px">${lastDate}</div></div>
                </div></div>
                ${data.positions&&data.positions.length?`<div class="history-section"><div class="history-title"><span>ğŸ“‹ æŒä»“æ˜ç»†</span><span>${data.positions.length} ä¸ª</span></div>
                    ${data.positions.slice(0,20).map(p=>{
                        const size=parseFloat(p.size)||0,price=parseFloat(p.price)||0,avgPrice=parseFloat(p.avgPrice)||0;
                        const curr=parseFloat(p.currentValue)||(size*price)||0;
                        const init=parseFloat(p.initialValue)||(size*avgPrice)||0;
                        const pnlPct=init>0?((curr-init)/init*100).toFixed(1):'0';
                        return `<div class="position-item">
                            <span class="position-outcome ${(p.outcome||'Yes').toLowerCase()}">${p.outcome||'Yes'}</span>
                            <span class="position-market">${p.title||p.marketSlug||'Unknown'}</span>
                            <div class="position-data">
                                <span class="position-val">æŠ•å…¥ ${fmtUSD(init)}</span>
                                <span class="position-val">ç°å€¼ ${fmtUSD(curr)}</span>
                                <span class="position-val" style="color:${curr>=init?'#10b981':'#ef4444'}">${curr>=init?'+':''}${pnlPct}%</span>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`:''}
                ${data.history&&data.history.length?`<div class="history-section"><div class="history-title"><span>ğŸ“œ äº¤æ˜“å†å²</span><span>${data.history.length} æ¡</span></div>
                    ${data.history.map(h=>`<div class="history-item">
                        <span class="history-type ${h.type}">${h.type==='buy'?'ä¹°å…¥':h.type==='sell'?'å–å‡º':'äº¤æ˜“'}</span>
                        <span class="history-market">${h.market||'Unknown'}</span>
                        <span class="history-amount">${fmtUSD(h.amount||0)}</span>
                        <span class="history-date">${h.timestamp?fmtTime(h.timestamp):''}</span>
                    </div>`).join('')}
                </div>`:'<div class="history-section"><div style="text-align:center;padding:25px;color:#6b7280">æš‚æ— äº¤æ˜“å†å²æ•°æ®</div></div>'}`;
        }else throw new Error(data.error||'æŸ¥è¯¢å¤±è´¥');
    }catch(e){
        info.className='info-box warning';
        info.innerHTML=`âŒ ${e.message}<br><a href="https://polymarket.com/profile/${addr}" target="_blank">åœ¨ Polymarket æŸ¥çœ‹ â†—</a> | <a href="https://polygonscan.com/address/${addr}" target="_blank">åœ¨ Polygonscan æŸ¥çœ‹ â†—</a>`;
    }
    btn.disabled=false;btn.textContent='æŸ¥è¯¢';
}

function showTab(id){
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
