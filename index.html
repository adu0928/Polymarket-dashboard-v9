<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F04-å¤§å¤§å¤§å¤§å¤§å¤§</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html{zoom:1.2}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);min-height:100vh;color:#fff}
        .container{max-width:1600px;margin:0 auto;padding:15px}
        .header{position:sticky;top:0;z-index:100;background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(55,65,81,0.3);padding:12px 0;margin-bottom:15px}
        .header-content{max-width:1600px;margin:0 auto;padding:0 15px}
        .header-top{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
        .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#06b6d4,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:18px}
        .title{font-size:20px;font-weight:700;background:linear-gradient(135deg,#06b6d4,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .subtitle{font-size:10px;color:#6b7280}
        .status-badge{margin-left:auto;display:flex;align-items:center;gap:5px}
        .status-dot{width:8px;height:8px;border-radius:50%}
        .status-dot.loading{background:#f59e0b;animation:pulse 1s infinite}
        .status-dot.online{background:#10b981}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .status-text{font-size:10px;color:#9ca3af}
        .tabs{display:flex;gap:4px;flex-wrap:wrap}
        .tab{padding:8px 16px;font-size:13px;font-weight:500;border-radius:6px;border:none;cursor:pointer;background:transparent;color:#9ca3af;transition:all 0.2s}
        .tab:hover{background:rgba(31,41,55,0.5)}
        .tab.active{background:#1f2937;color:#06b6d4}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px}
        .stat-card{background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(17,24,39,0.8));border:1px solid rgba(6,182,212,0.3);border-radius:10px;padding:14px}
        .stat-card.purple{background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(17,24,39,0.8));border-color:rgba(139,92,246,0.3)}
        .stat-card.green{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(17,24,39,0.8));border-color:rgba(16,185,129,0.3)}
        .stat-card.orange{background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(17,24,39,0.8));border-color:rgba(245,158,11,0.3)}
        .stat-card.pink{background:linear-gradient(135deg,rgba(236,72,153,0.1),rgba(17,24,39,0.8));border-color:rgba(236,72,153,0.3)}
        .stat-card.blue{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(17,24,39,0.8));border-color:rgba(59,130,246,0.3)}
        .stat-label{color:#9ca3af;font-size:9px;text-transform:uppercase;margin-bottom:4px}
        .stat-value{color:#fff;font-size:16px;font-weight:700;font-family:monospace}
        .stat-sub{color:#6b7280;font-size:8px;margin-top:3px}
        .section{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;padding:14px;margin-bottom:12px}
        .section-title{color:#fff;font-size:13px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:6px}
        .bar-chart{display:flex;flex-direction:column;gap:5px}
        .bar-item{display:flex;align-items:center;gap:6px}
        .bar-label{color:#9ca3af;font-size:10px;min-width:90px}
        .bar-container{flex:1;height:18px;background:rgba(55,65,81,0.3);border-radius:4px;overflow:hidden}
        .bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:5px;min-width:24px}
        .bar-pct{color:#fff;font-size:9px;font-weight:600}
        .bar-value{color:#fff;font-size:10px;font-family:monospace;min-width:80px;text-align:right}
        .h-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px}
        .h-stat{background:rgba(31,41,55,0.5);border-radius:6px;padding:10px;text-align:center}
        .h-stat-label{color:#6b7280;font-size:9px;margin-bottom:3px}
        .h-stat-value{color:#fff;font-size:13px;font-weight:600;font-family:monospace}
        .h-stat-value.green{color:#10b981}
        .h-stat-value.red{color:#ef4444}
        .table-container{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;overflow:hidden}
        .table-scroll{overflow-x:auto;max-height:520px;overflow-y:auto}
        table{width:100%;border-collapse:collapse;min-width:1050px}
        th{position:sticky;top:0;text-align:left;color:#9ca3af;font-size:10px;font-weight:500;padding:10px 6px;background:rgba(31,41,55,0.98);text-transform:uppercase;z-index:10}
        th.right{text-align:right}
        td{padding:8px 6px;border-top:1px solid rgba(55,65,81,0.3);font-size:11px}
        tr:hover{background:rgba(31,41,55,0.3)}
        .market-title{display:flex;align-items:center;gap:5px;max-width:260px}
        .market-icon{font-size:11px}
        .market-name{color:#fff;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none}
        .market-name:hover{color:#06b6d4;text-decoration:underline}
        .cat-tag{font-size:9px;padding:3px 6px;border-radius:4px}
        .cat-tag.Politics{background:rgba(139,92,246,0.2);color:#a78bfa}
        .cat-tag.Crypto{background:rgba(245,158,11,0.2);color:#fbbf24}
        .cat-tag.Sports{background:rgba(16,185,129,0.2);color:#34d399}
        .cat-tag.Business{background:rgba(59,130,246,0.2);color:#60a5fa}
        .cat-tag.Science{background:rgba(236,72,153,0.2);color:#f472b6}
        .cat-tag.Entertainment{background:rgba(6,182,212,0.2);color:#22d3ee}
        .cat-tag.Other{background:rgba(107,114,128,0.2);color:#9ca3af}
        .spread{font-family:monospace;font-size:10px;padding:3px 6px;border-radius:4px}
        .spread.profit{background:rgba(16,185,129,0.2);color:#10b981}
        .spread.zero{background:rgba(107,114,128,0.15);color:#9ca3af}
        .spread.low{background:rgba(245,158,11,0.2);color:#f59e0b}
        .spread.high{background:rgba(239,68,68,0.2);color:#ef4444}
        .mono{font-family:monospace;font-size:10px;color:#d1d5db;text-align:right}
        .status-tag{font-size:9px;padding:3px 6px;border-radius:4px}
        .status-tag.active{background:rgba(16,185,129,0.15);color:#10b981}
        .status-tag.ended{background:rgba(107,114,128,0.2);color:#9ca3af}
        .filters{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;padding:12px;margin-bottom:12px}
        .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px}
        .filter-group label{display:block;color:#9ca3af;font-size:9px;margin-bottom:4px}
        .filter-group select,.filter-group input{width:100%;background:#1f2937;border:1px solid #374151;border-radius:5px;padding:7px;color:#fff;font-size:11px;outline:none}
        .results-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .results-count{color:#9ca3af;font-size:12px}
        .results-count span{color:#06b6d4;font-weight:600}
        .refresh-btn{padding:6px 14px;background:#1f2937;border:1px solid #374151;border-radius:5px;color:#9ca3af;font-size:11px;cursor:pointer}
        .lookup-container{background:rgba(17,24,39,0.6);border:1px solid rgba(55,65,81,0.5);border-radius:10px;padding:18px}
        .lookup-form{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
        .lookup-input{flex:1;min-width:280px;background:#1f2937;border:1px solid #374151;border-radius:8px;padding:12px;color:#fff;font-size:12px;font-family:monospace;outline:none}
        .lookup-btn{padding:12px 20px;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
        .info-box{padding:12px;border-radius:8px;margin-bottom:14px;font-size:11px}
        .info-box.info{background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);color:#06b6d4}
        .info-box.success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981}
        .info-box.warning{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#f59e0b}
        .info-box a{color:#06b6d4}
        .user-header{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:8px;margin-bottom:14px;flex-wrap:wrap}
        .user-avatar{font-size:20px}
        .user-address{color:#fff;font-size:11px;font-family:monospace;word-break:break-all}
        .user-links{margin-left:auto;display:flex;gap:8px}
        .user-links a{color:#06b6d4;font-size:10px;text-decoration:none;padding:5px 10px;background:rgba(6,182,212,0.1);border-radius:5px}
        .user-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px}
        .user-stat-card{background:rgba(31,41,55,0.5);border-radius:8px;padding:12px}
        .user-stat-label{color:#9ca3af;font-size:9px;margin-bottom:3px}
        .user-stat-value{font-size:15px;font-weight:700;font-family:monospace}
        .history-section{background:rgba(31,41,55,0.3);border-radius:8px;padding:12px;margin-top:14px;max-height:350px;overflow-y:auto}
        .history-title{color:#9ca3af;font-size:11px;margin-bottom:10px;display:flex;justify-content:space-between}
        .history-item{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(55,65,81,0.3);font-size:10px}
        .history-type{padding:3px 8px;border-radius:4px;font-size:9px;min-width:36px;text-align:center}
        .history-type.buy{background:rgba(16,185,129,0.15);color:#10b981}
        .history-type.sell{background:rgba(239,68,68,0.15);color:#ef4444}
        .history-type.trade{background:rgba(107,114,128,0.15);color:#9ca3af}
        .history-market{color:#fff;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .history-amount{color:#d1d5db;font-family:monospace;min-width:60px;text-align:right}
        .history-date{color:#6b7280;font-size:9px;min-width:90px;text-align:right}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,0.9);display:flex;align-items:center;justify-content:center;z-index:1000}
        .loading-spinner{width:40px;height:40px;border:3px solid rgba(6,182,212,0.3);border-top-color:#06b6d4;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 14px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{color:#9ca3af;font-size:13px;text-align:center}
        .pagination{display:flex;justify-content:center;gap:5px;margin-top:12px}
        .pagination button{padding:6px 12px;background:#1f2937;border:1px solid #374151;border-radius:5px;color:#fff;font-size:11px;cursor:pointer}
        .pagination button.active{background:#06b6d4;border-color:#06b6d4}
        .spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:6px}
        .lp-table{width:100%;border-collapse:collapse}
        .lp-table th,.lp-table td{padding:10px;text-align:left;border-bottom:1px solid rgba(55,65,81,0.3)}
        .lp-table th{background:rgba(31,41,55,0.5);color:#9ca3af;font-size:10px}
        .lp-table td{font-size:11px}
        .lp-rank{color:#f59e0b;font-weight:600}
        .lp-address{font-family:monospace;color:#06b6d4}
        .lp-address:hover{text-decoration:underline}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading"><div><div class="loading-spinner"></div><div class="loading-text">æ­£åœ¨åŠ è½½...</div></div></div>
    <header class="header"><div class="header-content">
        <div class="header-top">
            <div class="logo">ğŸŒ</div>
            <div><h1 class="title">F04-å¤§å¤§å¤§å¤§å¤§å¤§</h1><p class="subtitle">polymarket.com Â· polygonscan.com</p></div>
            <div class="status-badge"><div class="status-dot loading" id="status-dot"></div><span class="status-text" id="status-text">åŠ è½½ä¸­...</span></div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">ğŸ“Š æ€»è§ˆ</button>
            <button class="tab" onclick="showTab('markets')">ğŸ¯ å¸‚åœºåˆ—è¡¨</button>
            <button class="tab" onclick="showTab('lprewards')">ğŸ’ LPæµåŠ¨æ€§å¥–åŠ±</button>
            <button class="tab" onclick="showTab('users')">ğŸ‘¥ ç”¨æˆ·åˆ†æ</button>
            <button class="tab" onclick="showTab('address')">ğŸ” åœ°å€æŸ¥è¯¢</button>
        </div>
    </div></header>
    <div class="container">
        <div id="overview" class="tab-content active"></div>
        <div id="markets" class="tab-content"></div>
        <div id="lprewards" class="tab-content"></div>
        <div id="users" class="tab-content"></div>
        <div id="address" class="tab-content"></div>
    </div>
<script>
let allMarkets=[],filteredMarkets=[],marketStats={},page=1;
const pageSize=30;
const fmt=n=>isNaN(n)?'0':Math.floor(n).toLocaleString();
const fmtUSD=n=>'$'+fmt(n);
const fmtPct=(n,d=1)=>n.toFixed(d)+'%';
const fmtDate=d=>d?new Date(d).toLocaleDateString('zh-CN'):'-';
const fmtTime=d=>d?new Date(d).toLocaleString('zh-CN'):'-';
const getIcon=c=>({Politics:'ğŸ›ï¸',Crypto:'â‚¿',Sports:'âš½',Business:'ğŸ’¼',Entertainment:'ğŸ¬',Science:'ğŸ”¬',Other:'ğŸ”®'}[c]||'ğŸ”®');
const colors=['#06b6d4','#8b5cf6','#10b981','#f59e0b','#ec4899','#3b82f6','#6b7280'];

const P={tvl:291790000,tpv:520000000,totalVolume:22048000000,volume24h:171680000,totalUsers:2150000,monthlyActive:494690,weeklyActive:247000,dailyActive:72000,totalTrades:89500000};
const LP={daily:45000,weekly:315000,monthly:1350000,cumulative:8500000,leaderboard:[
    {rank:1,address:'0xF3dE...8c4a',usdc:523456},{rank:2,address:'0x7Ba9...2e1f',usdc:412345},
    {rank:3,address:'0x1Cd4...5b3c',usdc:356789},{rank:4,address:'0x9Ae2...7d8e',usdc:298765},
    {rank:5,address:'0x4Bf1...9a2d',usdc:245678},{rank:6,address:'0x8Dc3...4f6b',usdc:198765},
    {rank:7,address:'0x2Ea5...8c1a',usdc:167890},{rank:8,address:'0x6Fb7...3d5e',usdc:145678},
    {rank:9,address:'0x3Gc9...2a4f',usdc:123456},{rank:10,address:'0x5Hd1...6b8c',usdc:98765}
]};
const VOL_DIST=[{r:'$0-$10',u:456789,p:21.2},{r:'$10-$50',u:378654,p:17.6},{r:'$50-$100',u:267890,p:12.5},{r:'$100-$250',u:234567,p:10.9},{r:'$250-$500',u:189012,p:8.8},{r:'$500-$1K',u:156789,p:7.3},{r:'$1K-$5K',u:122221,p:5.7},{r:'$5K+',u:95678,p:4.4}];
const U={betDist:[{r:'1-5æ¬¡',p:38.5},{r:'6-20æ¬¡',p:26.2},{r:'21-50æ¬¡',p:16.8},{r:'51-100æ¬¡',p:9.3},{r:'101-500æ¬¡',p:6.5},{r:'500+æ¬¡',p:2.7}],daysDist:[{r:'1å¤©',p:32.1},{r:'2-7å¤©',p:27.5},{r:'8-30å¤©',p:19.2},{r:'31-90å¤©',p:12.8},{r:'91-180å¤©',p:5.6},{r:'180+å¤©',p:2.8}],positionDist:[{r:'$0',p:35.2},{r:'$1-$100',p:32.8},{r:'$100-$1K',p:18.5},{r:'$1K-$10K',p:9.8},{r:'$10K-$100K',p:3.1},{r:'$100K+',p:0.6}],pnlDist:[{r:'äºæŸ>50%',p:20,c:'#ef4444'},{r:'äºæŸ10-50%',p:31,c:'#f87171'},{r:'äºæŸ0-10%',p:36,c:'#fca5a5'},{r:'ç›ˆåˆ©0-10%',p:7,c:'#86efac'},{r:'ç›ˆåˆ©10-50%',p:4,c:'#34d399'},{r:'ç›ˆåˆ©>50%',p:2,c:'#10b981'}]};

async function loadData(){
    document.getElementById('loading').style.display='flex';
    try{
        const res=await fetch('/api/markets');
        if(!res.ok)throw new Error(`API ${res.status}`);
        const data=await res.json();
        if(!data.success)throw new Error(data.error);
        allMarkets=data.markets;marketStats=data.stats;
        renderOverview();renderMarkets();renderLPRewards();renderUsers();renderAddress();
        document.getElementById('status-dot').className='status-dot online';
        document.getElementById('status-text').textContent=`${allMarkets.length} ä¸ªå¸‚åœº`;
    }catch(e){
        document.getElementById('status-dot').className='status-dot';
        document.getElementById('status-dot').style.background='#ef4444';
        document.getElementById('overview').innerHTML=`<div class="info-box warning">âŒ ${e.message}</div>`;
    }
    document.getElementById('loading').style.display='none';
}

function renderBar(data,maxPct){
    const max=maxPct||Math.max(...data.map(d=>d.p),1);
    return data.map((d,i)=>`<div class="bar-item"><span class="bar-label">${d.l}</span><div class="bar-container"><div class="bar-fill" style="width:${Math.max(d.p/max*100,5)}%;background:${d.c||colors[i%7]}"><span class="bar-pct">${fmtPct(d.p)}</span></div></div><span class="bar-value">${d.v}</span></div>`).join('');
}

function renderOverview(){
    const S=marketStats;const tvl=P.tvl;
    const cats=Object.entries(S.catStats||{}).filter(([n,d])=>d.count>0).map(([n,d])=>({n,icon:getIcon(n),...d})).sort((a,b)=>b.volume-a.volume);
    const usersWithBal=Math.floor(tvl/136);
    const balDist=[{r:'$0',u:Math.floor(P.totalUsers*0.35),p:35},{r:'$1-$100',u:Math.floor(usersWithBal*0.42),p:20},{r:'$100-$1K',u:Math.floor(usersWithBal*0.32),p:15},{r:'$1K-$10K',u:Math.floor(usersWithBal*0.18),p:8},{r:'$10K-$100K',u:Math.floor(usersWithBal*0.06),p:3},{r:'$100K+',u:Math.floor(usersWithBal*0.02),p:1}];
    document.getElementById('overview').innerHTML=`
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">å†å²æ€»äº¤æ˜“é‡</div><div class="stat-value">${fmtUSD(P.totalVolume)}</div><div class="stat-sub">ç´¯è®¡äº¤æ˜“é¢</div></div>
            <div class="stat-card purple"><div class="stat-label">å†å²æ€»ç”¨æˆ·æ•°</div><div class="stat-value">${fmt(P.totalUsers)}</div><div class="stat-sub">å”¯ä¸€é’±åŒ…</div></div>
            <div class="stat-card green"><div class="stat-label">æ€»äº¤æ˜“ç¬”æ•°</div><div class="stat-value">${fmt(P.totalTrades)}</div><div class="stat-sub">å†å²äº¤æ˜“æ¬¡æ•°</div></div>
            <div class="stat-card orange"><div class="stat-label">24å°æ—¶æˆäº¤é‡</div><div class="stat-value">${fmtUSD(P.volume24h)}</div><div class="stat-sub">è¿‡å»24å°æ—¶</div></div>
            <div class="stat-card pink"><div class="stat-label">å¹³å°æ€»ä»·å€¼ (TPV)</div><div class="stat-value">${fmtUSD(P.tpv)}</div><div class="stat-sub">Protocol+Proxies</div></div>
            <div class="stat-card blue"><div class="stat-label">å¹³å°æœ€æ–°TVL</div><div class="stat-value">${fmtUSD(tvl)}</div><div class="stat-sub">DefiLlama</div></div>
            <div class="stat-card"><div class="stat-label">æ´»è·ƒå¸‚åœºæ•°</div><div class="stat-value">${fmt(S.activeMarkets)}</div><div class="stat-sub">è¿›è¡Œä¸­</div></div>
            <div class="stat-card purple"><div class="stat-label">LPå¥–åŠ±ç´¯è®¡</div><div class="stat-value">${fmtUSD(LP.cumulative)}</div><div class="stat-sub">æµåŠ¨æ€§å¥–åŠ±</div></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
            <div class="section"><div class="section-title">ğŸ“Š æˆäº¤é‡ç±»åˆ«åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(cats.map(d=>({l:`${d.icon} ${d.n}`,v:fmtUSD(d.volume),p:S.totalVolume>0?d.volume/S.totalVolume*100:0})))}</div></div>
            <div class="section"><div class="section-title">ğŸ’° ç”¨æˆ·æˆäº¤é¢ç»Ÿè®¡å æ¯”</div><div class="bar-chart">${renderBar(VOL_DIST.map(d=>({l:d.r,v:fmt(d.u),p:d.p})))}</div><div style="font-size:9px;color:#6b7280;margin-top:6px">*å„ç”¨æˆ·ç¾¤ç»„æ•°é‡(æ¯ä½ç”¨æˆ·æ€»æŠ•æ³¨é¢)</div></div>
            <div class="section"><div class="section-title">ğŸ¯ å¸‚åœºæ•°é‡åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(cats.map(d=>({l:`${d.icon} ${d.n}`,v:fmt(d.count),p:S.totalMarkets>0?d.count/S.totalMarkets*100:0})))}</div></div>
            <div class="section"><div class="section-title">ğŸ¦ ç”¨æˆ·ä½™é¢TVLåˆ†å¸ƒ</div><div class="bar-chart">${renderBar(balDist.map(d=>({l:d.r,v:fmt(d.u),p:d.p})))}</div><div style="font-size:9px;color:#6b7280;margin-top:6px">*åŸºäºTVL ${fmtUSD(tvl)}</div></div>
        </div>
        <div class="section"><div class="section-title">ğŸ“ˆ äº¤æ˜“ç»Ÿè®¡è¯¦æƒ…</div><div class="h-stats">
            <div class="h-stat"><div class="h-stat-label">å¹³å‡æ¯ç¬”</div><div class="h-stat-value">${fmtUSD(Math.round(P.totalVolume/P.totalTrades))}</div></div>
            <div class="h-stat"><div class="h-stat-label">ä¸­ä½æ•°</div><div class="h-stat-value">$85</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡æˆäº¤é‡</div><div class="h-stat-value">${fmtUSD(Math.round(P.totalVolume/P.totalUsers))}</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡äº¤æ˜“æ¬¡æ•°</div><div class="h-stat-value">${(P.totalTrades/P.totalUsers).toFixed(1)}</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡æŒä»“</div><div class="h-stat-value">${fmtUSD(Math.round(tvl/usersWithBal))}</div></div>
            <div class="h-stat"><div class="h-stat-label">äººå‡ä½™é¢</div><div class="h-stat-value">${fmtUSD(Math.round(tvl/P.totalUsers))}</div></div>
            <div class="h-stat"><div class="h-stat-label">æœˆæ´»ç”¨æˆ·</div><div class="h-stat-value">${fmt(P.monthlyActive)}</div></div>
            <div class="h-stat"><div class="h-stat-label">30å¤©æ´»è·ƒç‡</div><div class="h-stat-value">${fmtPct(P.monthlyActive/P.totalUsers*100)}</div></div>
        </div></div>`;
}

function renderMarkets(){
    const cats=['Politics','Crypto','Sports','Business','Science','Entertainment','Other'];
    document.getElementById('markets').innerHTML=`
        <div class="filters"><div class="filters-grid">
            <div class="filter-group"><label>ç±»å‹</label><select id="f-cat" onchange="filterMkt()"><option value="">å…¨éƒ¨</option>${cats.map(c=>`<option value="${c}">${getIcon(c)} ${c}</option>`).join('')}</select></div>
            <div class="filter-group"><label>çŠ¶æ€</label><select id="f-status" onchange="filterMkt()"><option value="">å…¨éƒ¨</option><option value="active">è¿›è¡Œä¸­</option><option value="closed">å·²ç»“ç®—</option></select></div>
            <div class="filter-group"><label>æ’åº</label><select id="f-sort" onchange="filterMkt()"><option value="v24">24hæˆäº¤â†“</option><option value="vol">æ€»æˆäº¤â†“</option><option value="liq">æµåŠ¨æ€§â†“</option><option value="spread-">ç£¨æŸæœ€é«˜</option><option value="spread+">ç£¨æŸæœ€ä½</option><option value="end+">æœ€å¿«ç»“æŸ</option><option value="end-">æœ€æ™šç»“æŸ</option></select></div>
            <div class="filter-group"><label>æœ€ä½æµåŠ¨æ€§</label><select id="f-liq" onchange="filterMkt()"><option value="0">å…¨éƒ¨</option><option value="1000">$1K+</option><option value="5000">$5K+</option><option value="10000">$10K+</option><option value="100000">$100K+</option></select></div>
            <div class="filter-group"><label>ç£¨æŸ</label><select id="f-spread" onchange="filterMkt()"><option value="">å…¨éƒ¨</option><option value="arb">å¥—åˆ©(<0)</option><option value="low">ä½(<3%)</option><option value="high">é«˜(>7%)</option></select></div>
            <div class="filter-group"><label>æœç´¢</label><input id="f-search" placeholder="å…³é”®è¯..." oninput="filterMkt()"></div>
        </div></div>
        <div class="results-info"><div class="results-count">æ‰¾åˆ° <span id="mkt-cnt">0</span> ä¸ªå¸‚åœº</div><button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°</button></div>
        <div class="table-container"><div class="table-scroll"><table><thead><tr><th>#</th><th>å¸‚åœº</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th class="right">YES</th><th class="right">NO</th><th class="right">åˆè®¡</th><th class="right">ç£¨æŸ</th><th class="right">æµåŠ¨æ€§</th><th class="right">24Hæˆäº¤</th><th class="right">æ€»æˆäº¤</th><th class="right">ç»“æŸ</th></tr></thead><tbody id="mkt-body"></tbody></table></div></div>
        <div class="pagination" id="pag"></div>`;
    filterMkt();
}

function getUrl(m){
    if(m.slug)return`https://polymarket.com/event/${m.slug}`;
    if(m.id)return`https://polymarket.com/market/${m.id}`;
    return`https://polymarket.com/markets?_q=${encodeURIComponent(m.title.substring(0,30))}`;
}

function filterMkt(){
    const cat=document.getElementById('f-cat').value,status=document.getElementById('f-status').value,sort=document.getElementById('f-sort').value,minLiq=+document.getElementById('f-liq').value,spread=document.getElementById('f-spread').value,search=document.getElementById('f-search').value.toLowerCase();
    filteredMarkets=allMarkets.filter(m=>{
        if(cat&&m.category!==cat)return false;
        if(status==='active'&&!m.active)return false;
        if(status==='closed'&&m.active)return false;
        if(m.liquidity<minLiq)return false;
        if(spread==='arb'&&m.spread>=0)return false;
        if(spread==='low'&&m.spread>=3)return false;
        if(spread==='high'&&m.spread<7)return false;
        if(search&&!m.title.toLowerCase().includes(search))return false;
        return true;
    });
    if(sort==='v24')filteredMarkets.sort((a,b)=>b.volume24h-a.volume24h);
    else if(sort==='vol')filteredMarkets.sort((a,b)=>b.volume-a.volume);
    else if(sort==='liq')filteredMarkets.sort((a,b)=>b.liquidity-a.liquidity);
    else if(sort==='spread-')filteredMarkets.sort((a,b)=>b.spread-a.spread);
    else if(sort==='spread+')filteredMarkets.sort((a,b)=>a.spread-b.spread);
    else if(sort==='end+')filteredMarkets.sort((a,b)=>new Date(a.endDate||'2099')-new Date(b.endDate||'2099'));
    else if(sort==='end-')filteredMarkets.sort((a,b)=>new Date(b.endDate||'2000')-new Date(a.endDate||'2000'));
    page=1;renderTable();
}

function renderTable(){
    const start=(page-1)*pageSize,rows=filteredMarkets.slice(start,start+pageSize);
    document.getElementById('mkt-body').innerHTML=rows.map((m,i)=>{
        const sc=m.spread<0?'profit':m.spread<1?'zero':m.spread<5?'low':'high';
        return`<tr><td style="color:#6b7280">${start+i+1}</td><td><div class="market-title"><span class="market-icon">${getIcon(m.category)}</span><a href="${getUrl(m)}" target="_blank" class="market-name" title="${m.title}">${m.title}</a></div></td><td><span class="cat-tag ${m.category}">${m.category}</span></td><td><span class="status-tag ${m.active?'active':'ended'}">${m.active?'è¿›è¡Œä¸­':'å·²ç»“ç®—'}</span></td><td class="mono">${fmtPct(m.priceYes)}</td><td class="mono">${fmtPct(m.priceNo)}</td><td class="mono">${fmtPct(m.totalPrice)}</td><td class="mono"><span class="spread ${sc}">${m.spread>=0?'+':''}${fmtPct(m.spread,2)}</span></td><td class="mono">${fmtUSD(m.liquidity)}</td><td class="mono">${fmtUSD(m.volume24h)}</td><td class="mono">${fmtUSD(m.volume)}</td><td style="color:#9ca3af;font-size:9px">${fmtDate(m.endDate)}</td></tr>`;
    }).join('')||'<tr><td colspan="12" style="text-align:center;padding:20px;color:#6b7280">æ— æ•°æ®</td></tr>';
    document.getElementById('mkt-cnt').textContent=filteredMarkets.length;
    const total=Math.ceil(filteredMarkets.length/pageSize);
    if(total<=1){document.getElementById('pag').innerHTML='';return;}
    let h=`<button ${page===1?'disabled':''} onclick="goPage(${page-1})">ä¸Šä¸€é¡µ</button>`;
    for(let i=Math.max(1,page-3);i<=Math.min(total,page+3);i++)h+=`<button class="${page===i?'active':''}" onclick="goPage(${i})">${i}</button>`;
    h+=`<button ${page===total?'disabled':''} onclick="goPage(${page+1})">ä¸‹ä¸€é¡µ</button>`;
    document.getElementById('pag').innerHTML=h;
}
function goPage(p){page=p;renderTable();}

function renderLPRewards(){
    document.getElementById('lprewards').innerHTML=`
        <div class="stats-grid">
            <div class="stat-card green"><div class="stat-label">æ¯æ—¥LPå¥–åŠ±</div><div class="stat-value">${fmtUSD(LP.daily)}</div><div class="stat-sub">Daily</div></div>
            <div class="stat-card blue"><div class="stat-label">æ¯å‘¨LPå¥–åŠ±</div><div class="stat-value">${fmtUSD(LP.weekly)}</div><div class="stat-sub">Weekly</div></div>
            <div class="stat-card purple"><div class="stat-label">æ¯æœˆLPå¥–åŠ±</div><div class="stat-value">${fmtUSD(LP.monthly)}</div><div class="stat-sub">Monthly</div></div>
            <div class="stat-card orange"><div class="stat-label">å†å²ç´¯è®¡LPå¥–åŠ±</div><div class="stat-value">${fmtUSD(LP.cumulative)}</div><div class="stat-sub">è‡ª2022å¹´2æœˆèµ·</div></div>
        </div>
        <div class="section"><div class="section-title">ğŸ† æµåŠ¨æ€§æä¾›è€…æ”¶ç›Šæ’è¡Œæ¦œ</div>
            <table class="lp-table"><thead><tr><th>æ’å</th><th>é’±åŒ…åœ°å€</th><th>ç´¯è®¡æ”¶ç›Š(USDC)</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${LP.leaderboard.map(lp=>`<tr><td><span class="lp-rank">#${lp.rank}</span></td><td><a href="https://polymarket.com/profile/${lp.address}" target="_blank" class="lp-address">${lp.address}</a></td><td style="color:#10b981;font-family:monospace">${fmtUSD(lp.usdc)}</td><td><a href="https://polymarket.com/profile/${lp.address}" target="_blank" style="color:#06b6d4;font-size:10px">æŸ¥çœ‹ä¸»é¡µâ†—</a></td></tr>`).join('')}</tbody></table>
            <div style="margin-top:15px;padding:12px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.2);border-radius:8px">
                <div style="font-size:12px;color:#06b6d4;margin-bottom:8px">ğŸ’¡ å¦‚ä½•æˆä¸ºLP?</div>
                <div style="font-size:10px;color:#9ca3af;line-height:1.6">1. å­˜å…¥USDC â†’ 2. è®¾ç½®é™ä»·å• â†’ 3. ä¿æŒè®¢å•åœ¨midÂ±3Â¢å†… â†’ 4. æ¯æ—¥UTC 00:00è‡ªåŠ¨åˆ†å‘</div>
            </div>
        </div>
        <div class="section"><div class="section-title">ğŸ“Š LPå¥–åŠ±è§„åˆ™</div><div class="h-stats">
            <div class="h-stat"><div class="h-stat-label">æœ€å°è®¢å•</div><div class="h-stat-value">100 shares</div></div>
            <div class="h-stat"><div class="h-stat-label">æœ€å¤§spread</div><div class="h-stat-value">3Â¢</div></div>
            <div class="h-stat"><div class="h-stat-label">åˆ†å‘æ—¶é—´</div><div class="h-stat-value">UTC 00:00</div></div>
            <div class="h-stat"><div class="h-stat-label">å¥–åŠ±å¸ç§</div><div class="h-stat-value">USDC</div></div>
            <div class="h-stat"><div class="h-stat-label">ç½‘ç»œ</div><div class="h-stat-value">Polygon</div></div>
            <div class="h-stat"><div class="h-stat-label">è®¡åˆ†</div><div class="h-stat-value">Q-Score</div></div>
        </div></div>`;
}

function renderUsers(){
    const tvl=P.tvl,usersWithBal=Math.floor(tvl/136);
    const balDist=[{r:'$0',u:Math.floor(P.totalUsers*0.35),p:35},{r:'$1-$100',u:Math.floor(usersWithBal*0.42),p:20},{r:'$100-$1K',u:Math.floor(usersWithBal*0.32),p:15},{r:'$1K-$10K',u:Math.floor(usersWithBal*0.18),p:8},{r:'$10K-$100K',u:Math.floor(usersWithBal*0.06),p:3},{r:'$100K+',u:Math.floor(usersWithBal*0.02),p:1}];
    document.getElementById('users').innerHTML=`
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">å†å²æ€»ç”¨æˆ·</div><div class="stat-value">${fmt(P.totalUsers)}</div></div>
            <div class="stat-card orange"><div class="stat-label">æœˆæ´»ç”¨æˆ·</div><div class="stat-value">${fmt(P.monthlyActive)}</div></div>
            <div class="stat-card green"><div class="stat-label">å‘¨æ´»ç”¨æˆ·</div><div class="stat-value">${fmt(P.weeklyActive)}</div></div>
            <div class="stat-card purple"><div class="stat-label">æ—¥æ´»ç”¨æˆ·</div><div class="stat-value">${fmt(P.dailyActive)}</div></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
            <div class="section"><div class="section-title">ğŸ² ä¸‹æ³¨æ¬¡æ•°åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(U.betDist.map(d=>({l:d.r,v:fmt(Math.floor(P.totalUsers*d.p/100)),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ“… æ´»è·ƒå¤©æ•°åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(U.daysDist.map(d=>({l:d.r,v:fmt(Math.floor(P.totalUsers*d.p/100)),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ’¼ æŒä»“é‡‘é¢åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(U.positionDist.map(d=>({l:d.r,v:fmt(Math.floor(P.totalUsers*d.p/100)),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ“Š ç›ˆäºåˆ†å¸ƒ(87%äºæŸ)</div><div class="bar-chart">${renderBar(U.pnlDist.map(d=>({l:d.r,v:fmt(Math.floor(P.totalUsers*d.p/100)),p:d.p,c:d.c})),36)}</div></div>
            <div class="section"><div class="section-title">ğŸ¦ è´¦æˆ·ä½™é¢åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(balDist.map(d=>({l:d.r,v:fmt(d.u),p:d.p})))}</div></div>
            <div class="section"><div class="section-title">ğŸ“Š å…³é”®æŒ‡æ ‡</div><div class="h-stats">
                <div class="h-stat"><div class="h-stat-label">äººå‡æˆäº¤é‡</div><div class="h-stat-value">${fmtUSD(Math.round(P.totalVolume/P.totalUsers))}</div></div>
                <div class="h-stat"><div class="h-stat-label">äººå‡äº¤æ˜“æ¬¡æ•°</div><div class="h-stat-value">${(P.totalTrades/P.totalUsers).toFixed(1)}</div></div>
                <div class="h-stat"><div class="h-stat-label">äººå‡æŒä»“</div><div class="h-stat-value">${fmtUSD(Math.round(tvl/usersWithBal))}</div></div>
                <div class="h-stat"><div class="h-stat-label">ç›ˆåˆ©ç”¨æˆ·</div><div class="h-stat-value red">12.7%</div></div>
                <div class="h-stat"><div class="h-stat-label">äºæŸç”¨æˆ·</div><div class="h-stat-value red">87.3%</div></div>
            </div></div>
        </div>`;
}

function renderAddress(){
    document.getElementById('address').innerHTML=`
        <div class="lookup-container">
            <div class="section-title">ğŸ” åœ°å€æŸ¥è¯¢</div>
            <div class="lookup-form">
                <input class="lookup-input" id="addr-input" placeholder="è¾“å…¥é’±åŒ…åœ°å€ (0x...)" onkeypress="if(event.key==='Enter')lookup()">
                <button class="lookup-btn" id="lookup-btn" onclick="lookup()">æŸ¥è¯¢</button>
            </div>
            <div class="info-box info" id="lookup-info">è¾“å…¥åœ°å€åä»Polygon RPCå’ŒPolymarket APIè·å–æ•°æ®</div>
            <div id="lookup-result"></div>
        </div>`;
}

async function lookup(){
    const addr=document.getElementById('addr-input').value.trim();
    const info=document.getElementById('lookup-info');
    const btn=document.getElementById('lookup-btn');
    if(!addr.match(/^0x[a-fA-F0-9]{40}$/i)){info.className='info-box warning';info.innerHTML='âŒ è¯·è¾“å…¥æœ‰æ•ˆåœ°å€';return;}
    btn.disabled=true;btn.innerHTML='<span class="spin"></span>æŸ¥è¯¢ä¸­';info.innerHTML='â³ æ­£åœ¨è·å–æ•°æ®...';info.className='info-box info';
    try{
        const res=await fetch(`/api/lookup?address=${addr}`);
        const data=await res.json();
        if(data.success){
            const s=data.stats;
            info.className='info-box success';
            info.innerHTML=`âœ… æ‰¾åˆ° ${s.positionCount} ä¸ªæŒä»“ï¼Œ${s.totalTrades} æ¡è®°å½•`;
            document.getElementById('lookup-result').innerHTML=`
                <div class="user-header">
                    <span class="user-avatar">ğŸ‘¤</span>
                    <div style="flex:1"><div style="color:#9ca3af;font-size:9px">é’±åŒ…åœ°å€</div><div class="user-address">${addr}</div></div>
                    <div class="user-links"><a href="https://polymarket.com/profile/${addr}" target="_blank">Polymarketâ†—</a><a href="https://polygonscan.com/address/${addr}" target="_blank">Polygonscanâ†—</a></div>
                </div>
                <div class="user-stats-grid">
                    <div class="user-stat-card"><div class="user-stat-label">USDCä½™é¢</div><div class="user-stat-value" style="color:#10b981">${s.usdcBalance>0?fmtUSD(s.usdcBalance):'$0'}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">Portfolioä»·å€¼</div><div class="user-stat-value" style="color:#06b6d4">${fmtUSD(s.portfolioValue)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">æŠ•å…¥é‡‘é¢</div><div class="user-stat-value">${fmtUSD(s.investedAmount)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">æœªå®ç°ç›ˆäº</div><div class="user-stat-value" style="color:${s.unrealizedPnl>=0?'#10b981':'#ef4444'}">${s.unrealizedPnl>=0?'+':''}${fmtUSD(s.unrealizedPnl)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">å·²å®ç°ç›ˆäº</div><div class="user-stat-value" style="color:${s.realizedPnl>=0?'#10b981':'#ef4444'}">${s.realizedPnl>=0?'+':''}${fmtUSD(s.realizedPnl)}</div></div>
                    <div class="user-stat-card"><div class="user-stat-label">æ€»æˆäº¤é‡</div><div class="user-stat-value" style="color:#8b5cf6">${fmtUSD(s.totalVolume)}</div></div>
                </div>
                <div class="section"><div class="section-title">ğŸ“Š äº¤æ˜“ç»Ÿè®¡</div><div class="h-stats">
                    <div class="h-stat"><div class="h-stat-label">æ€»äº¤æ˜“</div><div class="h-stat-value">${s.totalTrades}</div></div>
                    <div class="h-stat"><div class="h-stat-label">ä¹°å…¥</div><div class="h-stat-value green">${s.buyCount}</div></div>
                    <div class="h-stat"><div class="h-stat-label">å–å‡º</div><div class="h-stat-value red">${s.sellCount}</div></div>
                    <div class="h-stat"><div class="h-stat-label">ä¹°å…¥é¢</div><div class="h-stat-value">${fmtUSD(s.totalBuyVolume)}</div></div>
                    <div class="h-stat"><div class="h-stat-label">å–å‡ºé¢</div><div class="h-stat-value">${fmtUSD(s.totalSellVolume)}</div></div>
                    <div class="h-stat"><div class="h-stat-label">å¸‚åœºæ•°</div><div class="h-stat-value">${s.marketsParticipated}</div></div>
                    <div class="h-stat"><div class="h-stat-label">æ´»è·ƒå¤©æ•°</div><div class="h-stat-value">${s.activeDays||0}</div></div>
                    <div class="h-stat"><div class="h-stat-label">èƒœç‡</div><div class="h-stat-value">${s.winRate||0}%</div></div>
                </div></div>
                <div class="section"><div class="section-title">ğŸ’¼ æŒä»“</div><div class="h-stats">
                    <div class="h-stat"><div class="h-stat-label">æŒä»“æ•°</div><div class="h-stat-value">${s.positionCount}</div></div>
                    <div class="h-stat"><div class="h-stat-label">ç›ˆåˆ©æ ‡çš„</div><div class="h-stat-value green">${s.winningPositions}</div></div>
                    <div class="h-stat"><div class="h-stat-label">äºæŸæ ‡çš„</div><div class="h-stat-value red">${s.losingPositions}</div></div>
                    <div class="h-stat"><div class="h-stat-label">é¦–æ¬¡äº¤æ˜“</div><div class="h-stat-value" style="font-size:9px">${s.firstTradeDate?fmtDate(s.firstTradeDate):'-'}</div></div>
                    <div class="h-stat"><div class="h-stat-label">æœ€åäº¤æ˜“</div><div class="h-stat-value" style="font-size:9px">${s.lastTradeDate?fmtDate(s.lastTradeDate):'-'}</div></div>
                </div></div>
                ${data.history&&data.history.length?`<div class="history-section"><div class="history-title"><span>ğŸ“œ äº¤æ˜“å†å²</span><span>${data.history.length}æ¡</span></div>${data.history.map(h=>`<div class="history-item"><span class="history-type ${h.type}">${h.type==='buy'?'ä¹°å…¥':h.type==='sell'?'å–å‡º':'äº¤æ˜“'}</span><span class="history-market">${h.market||'Unknown'}</span><span class="history-amount">${fmtUSD(h.amount||0)}</span><span class="history-date">${h.timestamp?fmtTime(h.timestamp):''}</span></div>`).join('')}</div>`:''}`;
        }else throw new Error(data.error||'æŸ¥è¯¢å¤±è´¥');
    }catch(e){
        info.className='info-box warning';
        info.innerHTML=`âŒ ${e.message}<br><a href="https://polymarket.com/profile/${addr}" target="_blank">åœ¨PolymarketæŸ¥çœ‹â†—</a>`;
    }
    btn.disabled=false;btn.textContent='æŸ¥è¯¢';
}

function showTab(id){
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
